<div class="page-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  <div class="page-header">
    <div class="header-content">
      <h1>Transacciones</h1>
      <p class="subtitle">Gestiona los ingresos y gastos de la finca</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openNew()">
        <span class="material-symbols-rounded">add</span>
        Nueva Transacción
      </button>
    </div>
  </div>

  <p-dialog
    [(visible)]="transactionDialog"
    [style]="{ width: '550px' }"
    [header]="isEditMode() ? 'Editar Transacción' : 'Nueva Transacción'"
    [modal]="true"
    styleClass="p-fluid"
    [draggable]="false"
    [resizable]="false"
  >
    <ng-template pTemplate="content">
      <form [formGroup]="transactionForm" class="transaction-form">
        <!-- Tipo de Transacción -->
        <div class="field">
          <label for="type" class="block font-bold mb-2">Tipo</label>
          <p-selectButton
            inputId="type"
            [options]="transactionTypes"
            formControlName="type"
            optionLabel="label"
            optionValue="value"
            [unselectable]="false"
            [style]="{ width: '100%' }"
          >
          </p-selectButton>
        </div>

        <!-- Fecha -->
        <div class="field">
          <label for="date" class="block font-bold mb-2">Fecha</label>
          <p-datepicker
            id="date"
            formControlName="date"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            appendTo="body"
          >
          </p-datepicker>
        </div>

        <!-- Categoría -->
        <div class="field">
          <label for="category" class="block font-bold mb-2">Categoría</label>
          <p-select
            id="category"
            [options]="categories()"
            formControlName="categoryId"
            optionLabel="name"
            optionValue="id"
            placeholder="Seleccionar Categoría"
            appendTo="body"
          >
          </p-select>
        </div>

        <!-- Quantity (Optional) -->
        <div class="field">
          <label for="quantity" class="block font-bold mb-2">Cantidad (Opcional)</label>
          <p-inputNumber
            id="quantity"
            formControlName="quantity"
            mode="decimal"
            [minFractionDigits]="0"
            [maxFractionDigits]="2"
            placeholder="0"
          >
          </p-inputNumber>
        </div>

        <!-- Monto -->
        <div class="field">
          <label for="amount" class="block font-bold mb-2">Monto</label>
          <p-inputNumber
            id="amount"
            formControlName="totalAmount"
            mode="currency"
            currency="USD"
            locale="en-US"
            placeholder="0.00"
          >
          </p-inputNumber>
        </div>

        <!-- Notas -->
        <div class="field">
          <label for="notes" class="block font-bold mb-2">Notas</label>
          <textarea pTextarea id="notes" formControlName="notes" rows="3" class="w-full">
          </textarea>
        </div>
      </form>
    </ng-template>

    <ng-template pTemplate="footer">
      <button
        type="button"
        pButton
        pRipple
        label="Cancelar"
        icon="pi pi-times"
        class="p-button-danger confirm-no-btn"
        (click)="hideDialog()"
      ></button>
      <button
        type="button"
        pButton
        pRipple
        label="Guardar"
        icon="pi pi-check"
        class="p-button-success confirm-yes-btn"
        (click)="saveTransaction()"
        [loading]="loading()"
      ></button>
    </ng-template>
  </p-dialog>

  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando transacciones...</p>
    </div>
  }

  @if (error()) {
    <div class="error-state">
      <span class="material-symbols-rounded">error</span>
      <p>{{ error() }}</p>
      <button (click)="loadTransactions()" class="btn btn-outline">Reintentar</button>
    </div>
  }

  @if (!loading() && !error()) {
    <div class="content-card">
      @if (transactions().length > 0) {
        <table class="modern-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Categoría</th>
              <th>Concepto/Notas</th>
              <th>Cantidad</th>
              <th>Monto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (t of transactions(); track t.id) {
              <tr>
                <td>
                  <div class="date-cell">
                    <span class="material-symbols-rounded icon">calendar_today</span>
                    {{ t.date | date: 'dd/MM/yyyy HH:mm:ss' }}
                  </div>
                </td>
                <td>
                  <span
                    class="badge"
                    [class.badge-income]="t.type === 'INGRESO'"
                    [class.badge-expense]="t.type === 'GASTO'"
                  >
                    {{ t.type === 'INGRESO' ? 'Ingreso' : 'Gasto' }}
                  </span>
                </td>
                <td>
                  <!-- Category name placeholder until relation is populated/mapped -->
                  {{ t.category.name || 'General' }}
                </td>
                <td class="notes-cell" title="{{ t.notes }}">
                  {{ t.notes || '-' }}
                </td>
                <td class="amount-cell">{{ t.quantity }}</td>
                <td class="amount-cell">{{ t.totalAmount | currency }}</td>
                <td class="actions-cell">
                  <button class="icon-btn" title="Editar" (click)="editTransaction(t)">
                    <span class="material-symbols-rounded">edit</span>
                  </button>
                  <button class="icon-btn delete" title="Eliminar" (click)="deleteTransaction(t)">
                    <span class="material-symbols-rounded">delete</span>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <p-paginator
          (onPageChange)="onPageChange($event)"
          [first]="(page() - 1) * limit()"
          [rows]="limit()"
          [totalRecords]="total()"
          [rowsPerPageOptions]="[5, 10, 25, 100]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {last} de {totalRecords}"
          styleClass="custom-paginator"
        >
        </p-paginator>
      } @else {
        <div class="no-data">
          <span class="material-symbols-rounded">receipt_long</span>
          <p>No hay transacciones registradas.</p>
          <button class="btn btn-primary">Crear primera transacción</button>
        </div>
      }
    </div>
  }
</div>
